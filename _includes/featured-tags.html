
{% comment %}
  Featured tags from: research, festival, moderation, poetry
  Respects site.featured-tags and site.featured-condition-size
  Compatible with GitHub Pages (Jekyll 3.10 / Liquid 4)
{% endcomment %}

{% if site.featured-tags %}
<section>
  {% if include.bottom %}
    <hr class="hidden-sm hidden-xs">
  {% endif %}
  <h5><a href="{{ '/archive/' | relative_url }}">FEATURED TAGS</a></h5>

  {%- comment -%} 1) Gather all docs, nil-safe {%- endcomment -%}
  {% assign research   = site.research %}{% if research   == nil %}{% assign research   = '' | split: '' %}{% endif %}
  {% assign festival   = site.festival %}{% if festival   == nil %}{% assign festival   = '' | split: '' %}{% endif %}
  {% assign moderation = site.moderation %}{% if moderation == nil %}{% assign moderation = '' | split: '' %}{% endif %}
  {% assign poetry     = site.poetry     %}{% if poetry     == nil %}{% assign poetry     = '' | split: '' %}{% endif %}

  {% assign all = research | concat: festival | concat: moderation | concat: poetry %}
  {% assign total = all | size %}

  {%- comment -%} 2) Build unique tag list (string â†’ uniq) {%- endcomment -%}
  {% capture all_tags %}{% endcapture %}
  {% for d in all %}
    {% if d.tags %}
      {% for t in d.tags %}
        {% capture all_tags %}{{ all_tags }}|{{ t | strip }}{% endcapture %}
      {% endfor %}
    {% endif %}
  {% endfor %}
  {% assign uniq = all_tags | split: '|' | uniq | sort %}
  {# remove empty entries #}
  {% assign cleaned = '' | split: '' %}
  {% for tag in uniq %}
    {% unless tag == '' %}
      {% assign cleaned = cleaned | push: tag %}
    {% endunless %}
  {% endfor %}

  <div class="tags">
    {% capture tags_markup %}{% endcapture %}
    {% for tag in cleaned %}
      {%- comment -%} 3) Count occurrences of each tag across 'all' {%- endcomment -%}
      {% assign count = 0 %}
      {% for d in all %}
        {% if d.tags and d.tags contains tag %}
          {% assign count = count | plus: 1 %}
        {% endif %}
      {% endfor %}

      {% assign min_size = site.featured-condition-size | default: 0 %}
      {% if count > min_size %}
        {% capture tags_markup -%}
          {{ tags_markup }}
          <a
            data-sort="{{ total | minus: count | prepend: '0000' | slice: -4, 4 }}"
            href="{{ '/archive/' | relative_url }}?tag={{ tag | url_encode }}"
            title="{{ tag }}" rel="{{ count }}">{{ tag }}</a>__SEP__
        {%- endcapture %}
      {% endif %}
    {% endfor %}

    {{ tags_markup | split: '__SEP__' | sort }}
  </div>
</section>
{% endif %}
