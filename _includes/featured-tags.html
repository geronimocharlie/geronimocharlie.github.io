{% comment %}
  Featured tags built from: research, festival, moderation, poetry
  Uses site.featured-tags and site.featured-condition-size like the original.
{% endcomment %}

{% if site.featured-tags %}
<section>
  {% if include.bottom %}
    <hr class="hidden-sm hidden-xs">
  {% endif %}
  <h5><a href="{{ '/archive/' | relative_url }}">FEATURED TAGS</a></h5>

  {%- comment -%} Gather all docs (nil-safe) {%- endcomment -%}
  {% assign research          = site.research %}{% if research          == nil %}{% assign research          = '' | split: '' %}{% endif %}
  {% assign festivals         = site.festivals %}{% if festivals         == nil %}{% assign festivals         = '' | split: '' %}{% endif %}
  {% assign creative_writing  = site.creative_writing %}{% if creative_writing  == nil %}{% assign creative_writing  = '' | split: '' %}{% endif %}
  {% assign moderations       = site.moderations %}{% if moderations       == nil %}{% assign moderations       = '' | split: '' %}{% endif %}
  {% assign poetry            = site.poetry %}{% if poetry            == nil %}{% assign poetry            = '' | split: '' %}{% endif %}

  {% assign all = research | concat: festivals | concat: moderations | concat: creative_writing | concat: poetry %}

  {%- comment -%} Keep only items that have a date (no where_exp in GH Pages) {%- endcomment -%}
  {% assign filtered = '' | split: '' %}
  {% for i in all %}
    {% if i.date %}
      {% assign filtered = filtered | push: i %}
    {% endif %}
  {% endfor %}
  {% assign all = filtered %}
  {% assign total = all | size %}

  {%- comment -%} Build unique tag list (no sort_natural, no where_exp) {%- endcomment -%}
  {% capture tag_str %}{% endcapture %}
  {% for d in all %}
    {% if d.tags %}
      {% for t in d.tags %}
        {% capture tag_str %}{{ tag_str }}|{{ t | strip }}{% endcapture %}
      {% endfor %}
    {% endif %}
  {% endfor %}

  {% assign uniq = tag_str | split: "|" | uniq | sort %}

  {%- comment -%} remove empty entries (since we split a leading '|') {%- endcomment -%}
  {% assign uniq_clean = '' | split: '' %}
  {% for t in uniq %}
    {% unless t == '' %}
      {% assign uniq_clean = uniq_clean | push: t %}
    {% endunless %}
  {% endfor %}



<div class="tags">
  {% capture tags_markup %}{% endcapture %}
  {% assign min_size = site.featured-condition-size | default: 0 %}

  {% for t in uniq_clean %}
    {% assign count = 0 %}
    {% for i in all %}
      {% if i.tags and i.tags contains t %}
        {% assign count = count | plus: 1 %}
      {% endif %}
    {% endfor %}

    {% if count > min_size %}
      {% capture tags_markup -%}
        {{ tags_markup }}
        <a
          data-sort="{{ total | minus: count | prepend: '0000' | slice: -4, 4 }}"
          href="{{ '/archive/' | relative_url }}?tag={{ t | url_encode }}"
          title="{{ t }}" rel="{{ count }}">{{ t }}</a>__SEPARATOR__
      {%- endcapture %}
    {% endif %}
  {% endfor %}

  {{ tags_markup | split: '__SEPARATOR__' | sort }}
</div>
</section>
{% endif %}

